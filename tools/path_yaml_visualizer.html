<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Path YAML Visualizer</title>
<script src="https://cdn.jsdelivr.net/npm/js-yaml@4/dist/js-yaml.min.js"></script>
<style>
 body { font-family: Arial, sans-serif; margin:20px; }
 table { border-collapse: collapse; width: 100%; margin-top:10px; }
 th, td { border: 1px solid #ccc; padding: 4px; }
 .error { background: #ffe6e6; }
</style>
</head>
<body>
<h1>Path YAML Visualizer</h1>
<p>Load a <code>path.yaml</code> file to view its stage structure.</p>
<input type="file" id="fileInput" accept=".yaml,.yml" />
<div id="errors"></div>
<div id="tree"></div>
<script>
const fileInput = document.getElementById('fileInput');
fileInput.addEventListener('change', handleFile);
document.addEventListener('dragover', e => e.preventDefault());
document.addEventListener('drop', e => {
  e.preventDefault();
  if (e.dataTransfer.files.length) {
    fileInput.files = e.dataTransfer.files;
    handleFile();
  }
});

function handleFile() {
  const file = fileInput.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => parseYaml(e.target.result);
  reader.readAsText(file);
}

function parseYaml(text) {
  document.getElementById('errors').innerHTML = '';
  document.getElementById('tree').innerHTML = '';
  let data;
  try {
    data = jsyaml.load(text);
  } catch (err) {
    document.getElementById('errors').textContent = 'YAML parse error: ' + err;
    return;
  }
  const stageIds = new Set();
  if (Array.isArray(data.stages)) {
    for (const stage of data.stages) {
      if (stage.id) stageIds.add(stage.id);
    }
  }
  const errors = [];
  const table = document.createElement('table');
  const header = document.createElement('tr');
  header.innerHTML = '<th>ID</th><th>Title</th><th>PackId</th><th>UnlockCondition</th>';
  table.appendChild(header);
  if (Array.isArray(data.stages)) {
    for (const stage of data.stages) {
      addStageRow(table, stage, stageIds, errors);
      if (Array.isArray(stage.subStages)) {
        for (const sub of stage.subStages) {
          addSubStageRow(table, sub, stageIds, errors);
        }
      }
    }
  }
  document.getElementById('tree').appendChild(table);
  if (errors.length) {
    document.getElementById('errors').innerHTML = '<h2>Errors</h2><ul>' + errors.map(e => `<li>${e}</li>`).join('') + '</ul>';
  }
}

function formatUnlock(uc) {
  if (!uc) return '';
  const parts = [];
  if (uc.dependsOn) parts.push('dependsOn: ' + uc.dependsOn);
  if (uc.minAccuracy) parts.push('minAccuracy: ' + uc.minAccuracy);
  return parts.join(', ');
}

function addStageRow(table, stage, stageIds, errors) {
  const tr = document.createElement('tr');
  tr.innerHTML = `<td><strong>${stage.id ?? ''}</strong></td><td>${stage.title ?? ''}</td><td>${stage.packId ?? ''}</td><td>${formatUnlock(stage.unlockCondition)}</td>`;
  if (!stage.packId) {
    tr.classList.add('error');
    errors.push(`Stage ${stage.id} missing packId`);
  }
  if (stage.unlockCondition && stage.unlockCondition.dependsOn && !stageIds.has(stage.unlockCondition.dependsOn)) {
    tr.classList.add('error');
    errors.push(`Stage ${stage.id} unlock dependsOn unknown stage ${stage.unlockCondition.dependsOn}`);
  }
  table.appendChild(tr);
}

function addSubStageRow(table, sub, stageIds, errors) {
  const tr = document.createElement('tr');
  tr.innerHTML = `<td style="padding-left:20px">${sub.id ?? ''}</td><td>${sub.title ?? ''}</td><td>${sub.packId ?? ''}</td><td>${formatUnlock(sub.unlockCondition)}</td>`;
  if (!sub.packId) {
    tr.classList.add('error');
    errors.push(`SubStage ${sub.id} missing packId`);
  }
  if (sub.unlockCondition && sub.unlockCondition.dependsOn && !stageIds.has(sub.unlockCondition.dependsOn)) {
    tr.classList.add('error');
    errors.push(`SubStage ${sub.id} unlock dependsOn unknown stage ${sub.unlockCondition.dependsOn}`);
  }
  table.appendChild(tr);
}
</script>
</body>
</html>
